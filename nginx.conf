user nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log warn;\npid /var/run/nginx.pid;\n\nevents {\n    worker_connections 1024;\n    use epoll;\n}\n\nhttp {\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\n    log_format main '$remote_addr - $remote_user [$time_local] \"$request\" '\n                    '$status $body_bytes_sent \"$http_referer\" '\n                    '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log /var/log/nginx/access.log main;\n\n    # Performance optimizations\n    sendfile on;\n    tcp_nopush on;\n    tcp_nodelay on;\n    keepalive_timeout 65;\n    types_hash_max_size 2048;\n    client_max_body_size 100M;\n\n    # Gzip compression\n    gzip on;\n    gzip_vary on;\n    gzip_proxied any;\n    gzip_comp_level 6;\n    gzip_types text/plain text/css text/xml text/javascript \n               application/json application/javascript application/xml+rss \n               application/rss+xml font/truetype font/opentype \n               application/vnd.ms-fontobject image/svg+xml;\n\n    # Rate limiting\n    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;\n    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;\n    limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/m;\n\n    # Upstream app server\n    upstream app_server {\n        server app:3000 max_fails=3 fail_timeout=30s;\n        keepalive 32;\n    }\n\n    # HTTP redirect to HTTPS\n    server {\n        listen 80;\n        server_name _;\n        return 301 https://$host$request_uri;\n    }\n\n    # HTTPS server\n    server {\n        listen 443 ssl http2;\n        server_name _;\n\n        # SSL configuration\n        ssl_certificate /etc/nginx/ssl/cert.pem;\n        ssl_certificate_key /etc/nginx/ssl/key.pem;\n        ssl_protocols TLSv1.2 TLSv1.3;\n        ssl_ciphers HIGH:!aNULL:!MD5;\n        ssl_prefer_server_ciphers on;\n        ssl_session_cache shared:SSL:10m;\n        ssl_session_timeout 10m;\n\n        # Security headers\n        add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;\n        add_header X-Frame-Options \"SAMEORIGIN\" always;\n        add_header X-Content-Type-Options \"nosniff\" always;\n        add_header X-XSS-Protection \"1; mode=block\" always;\n        add_header Referrer-Policy \"strict-origin-when-cross-origin\" always;\n        add_header Permissions-Policy \"geolocation=(), microphone=(), camera=()\" always;\n\n        # Root location\n        root /app/dist;\n        index index.html index.htm;\n\n        # Static files with caching\n        location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {\n            expires 1y;\n            add_header Cache-Control \"public, immutable\";\n        }\n\n        # API routes\n        location /api/ {\n            limit_req zone=api burst=50 nodelay;\n            proxy_pass http://app_server;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection 'upgrade';\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_cache_bypass $http_upgrade;\n            proxy_read_timeout 30s;\n            proxy_connect_timeout 10s;\n        }\n\n        # Auth routes\n        location /auth/ {\n            limit_req zone=auth burst=10 nodelay;\n            proxy_pass http://app_server;\n            proxy_http_version 1.1;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n        }\n\n        # Health check endpoint\n        location /health {\n            access_log off;\n            proxy_pass http://app_server;\n            proxy_http_version 1.1;\n            proxy_set_header Connection \"\";\n        }\n\n        # SPA fallback\n        location / {\n            limit_req zone=general burst=20 nodelay;\n            try_files $uri $uri/ /index.html;\n            proxy_pass http://app_server;\n            proxy_http_version 1.1;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n        }\n\n        # Deny access to sensitive files\n        location ~ /\\. {\n            deny all;\n            access_log off;\n            log_not_found off;\n        }\n\n        location ~ ~$ {\n            deny all;\n            access_log off;\n            log_not_found off;\n        }\n    }\n}\n
